<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>HAK Stonks</title>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            gameState = loadGameState();
            loadMutedState();
            showUsernamePrompt();
            updateChallenges();
            updateGameStateUI();
            handleCookieConsent();
            showLeaderboard();
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="prefetch" href="coin.png" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        :root {
            --primary-color: #2c0051;
            --secondary-color: #ff006e;
            --accent-color: #00ff88;
            --background-dark: #120024;
            --text-light: #ffffff;
            --orange: #ffac1c;
            --text-dim: rgba(255, 255, 255, 0.7);
        }

        body {
            background: radial-gradient(circle at center, var(--primary-color), var(--background-dark));
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
        }

        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            letter-spacing: 4px;
        }

        .game-container {
            display: flex;
            gap: 2rem;
            position: relative;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 20px;
            width: 320px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .mode-switch {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50px;
            padding: 4px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-switch button {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-light);
            padding: 12px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-switch button.active {
            background: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 0, 110, 0.3);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.8rem;
            color: var(--text-dim);
            font-weight: 500;
        }

        input[type="number"] {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-light);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.8);
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #e7e7e7;
        }

        .level-xp-stat {
            font-size: 0.92rem;
            text-align: right;
            color: var(--text-light);
        }

        .bet-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-color), #00cc6a);
            border: none;
            border-radius: 12px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .bet-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        #drop-btn-all {
            margin-top: 5px;
            background: linear-gradient(135deg, #ff4500, #ff0000);
            color: var(--text-light);
            z-index: 3;
        }

        #drop-btn-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 0, 0.4);
        }

        #plinko-board {
            position: relative;
            width: 800px;
            height: 550px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .peg {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .peg:hover {
            transform: scale(1.5);
            background: var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color);
        }

        .chip {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color);
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .buckets {
            position: absolute;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            gap: 4px;
        }

        .bucket {
            flex: 1;
            height: 80px;
            border-radius: 12px 12px 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .bucket.winning {
            transform: scale(1.1) translateY(-10px);
            box-shadow: 0 0 30px var(--accent-color);
        }

        .multiplier {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-light);
        }

        #message-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.5rem;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 100;
            pointer-events: none;
            text-align: center;
        }

        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: linear-gradient(135deg, var(--secondary-color), var(--orange));
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle 0.8s ease-out;
        }

        @keyframes sparkle {
            0% {
                transform: scale(0);
                opacity: 1;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        #mute-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        #mute-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        #level-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .achievement-popup {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            padding: 20px 40px;
            border-radius: 50px;
            text-align: center;
            z-index: 200;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        #daily-challenge {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        #daily-challenge:hover {
            transform: translateY(-5px);
        }

        #cookie-consent {
            position: absolute;
            bottom: 2rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: none;
        }

        #cookie-consent:hover {
            transform: translateY(-5px);
        }

        #cookie-consent a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .cookie-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 5px;
        }

        #accept-cookies,
        #decline-cookies {
            padding: 0.8rem 1.5rem;
            background: var(--accent-color);
            border: none;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #decline-cookies {
            background: var(--secondary-color);
            color: var(--text-light);
        }

        #accept-cookies:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        #decline-cookies:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 0, 0.4);
        }

        .challenge-container {
            position: fixed;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 250px;
            z-index: 0;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .challenge-container:hover {
            opacity: 1;
            z-index: 1000;
        }

        .challenge-container h3 {
            margin-bottom: 10px;
        }

        .data-display {
            position: fixed;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 300px;
            transition: opacity 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 0;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .data-display:hover {
            opacity: 1;
            z-index: 1000;
        }

        .data-display h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1.25rem;
            text-align: center;
        }

        #leaderboard {
            width: 100%;
        }

        #leaderboard table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
        }

        #leaderboard thead tr th {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            text-align: left;
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        #leaderboard tbody tr {
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        #leaderboard tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        #leaderboard tbody tr td {
            padding: 0.75rem;
            color: white;
            font-weight: 500;
        }

        #leaderboard tbody tr:first-child {
            background: linear-gradient(to right,
                    rgba(245, 158, 11, 0.2),
                    rgba(251, 191, 36, 0.2));
        }

        #leaderboard tbody tr:first-child:hover {
            background: linear-gradient(to right,
                    rgba(245, 158, 11, 0.3),
                    rgba(251, 191, 36, 0.3));
        }

        #leaderboard tbody tr:first-child td {
            color: #fbbf24;
            font-weight: 700;
        }

        .challenge-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .challenge-title {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary-color);
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <h1 class="game-title">HAK Stonks</h1>
    <div id="daily-challenge">
        Daily Challenge:
        <br>
        <span id="challenge-description">Win 1000x multiplier</span>
        <br> Progress: <span id="challenge-progress">0/1</span>
    </div>
    <div id="cookie-consent">
        <p>We use Cookies
            <br><a href="https://example.com/cookie-policy" target="_blank">Learn more</a>
        </p>
        <div class="cookie-buttons">
            <button id="accept-cookies">Accept</button>
            <button id="decline-cookies">Decline</button>
        </div>
    </div>

    <div id="message-overlay"></div>
    <div id="level-display">Level: <span id="current-level">1</span></div>
    <div id="achievement-popup" class="achievement-popup">
        🏆 Achievement Unlocked!
        <br>
        <span id="achievement-name"></span>
    </div>
    <div class="challenge-container">
        <h3>Active Challenges</h3>
        <div id="weekly-challenges"></div>
    </div>
    <div class="data-display">
        <h2>🏆 Leaderboard</h2>
        <div id="leaderboard"></div>
    </div>
    <div class="game-container">
        <div class="controls-panel">
            <div class="mode-switch">
                <button class="active">Manual</button>
                <button>Auto</button>
            </div>
            <div class="control-group">
                <label>Bet Amount</label>
                <input type="number" id="bet-amount" value="1" min="1" step="1">
                <div class="game-stats">
                    <span>Balance: <br>€<span id="balance">1000.00</span></span>
                    <span class="level-xp-stat">Level XP: <br><span id="level-xp">0/100</span></span>
                </div>
            </div>
            <button class="bet-button" id="drop-btn">Place Bet</button>
            <button class="bet-button" id="drop-btn-all">All In</button>
        </div>
        <div id="plinko-board">
            <div class="buckets"></div>
        </div>
    </div>

    <audio id="background-music-1" src="bg-1.mp3" autoplay loop></audio>
    <audio id="background-music-2" src="bg-2.mp3" autoplay loop></audio>
    <audio id="background-music-3" src="bg-3.mp3" autoplay loop></audio>
    <audio id="background-music-4" src="bg-4.mp3" autoplay loop></audio>
    <audio id="background-music-5" src="bg-5.mp3" autoplay loop></audio>
    <audio id="background-music-6" src="bg-6.mp3" autoplay loop></audio>
    <audio id="coin-drop-sound" src="coin-drop-1.mp3"></audio>
    <audio id="win-sound" src="cash-register-01.mp3"></audio>
    <audio id="big-win-sound" src="big-win-audio.mp3"></audio>
    <audio id="medium-win-sound" src="medium-win-sound.mp3"></audio>
    <audio id="medium-win-audio" src="medium-win-audio.mp3"></audio>
    <audio id="cash-sound" src="cash.mp3"></audio>

    <button id="mute-btn">🔊</button>
    <script>
        const board = document.getElementById('plinko-board');
        const balanceEl = document.getElementById('balance');
        const betInput = document.getElementById('bet-amount');
        const dropBtn = document.getElementById('drop-btn');
        const dropBtnAll = document.getElementById('drop-btn-all');
        const messageOverlay = document.getElementById('message-overlay');
        const levelEl = document.getElementById('current-level');
        const levelXpEl = document.getElementById('level-xp');
        const achievementPopup = document.getElementById('achievement-popup');
        const achievementNameEl = document.getElementById('achievement-name');
        const dailyChallengeDesc = document.getElementById('challenge-description');
        const dailyChallengeProgress = document.getElementById('challenge-progress');

        const coinDropSound = document.getElementById('coin-drop-sound');
        const winSound = document.getElementById('win-sound');
        const mediumWinSound = document.getElementById('medium-win-sound');
        const mediumWinAudio = document.getElementById('medium-win-audio');
        const bigWinSound = document.getElementById('big-win-sound');
        const cashSound = document.getElementById('cash-sound');

        let isSpaceHeld = false;
        let spaceHoldInterval;
        let isPageFocused = true;

        let isAutoMode = false;
        let autoDropInterval;

        let isMuted = false;


        let gameState = {
            balance: 1000,
            level: 1,
            xp: 0,
            streak: 0,
            soundEnabled: true,
            dailyChallenge: {
                type: 'multiplier',
                target: 1000,
                current: 0,
                completed: false
            },
            gameCount: 0,
            weeklyProgress: {
                winStreak: 0,
                highestMultiplier: 0,
                totalBets: 0,
                totalWinnings: 0
            },
            achievements: {
                firstWin: false,
                tenXWin: false,
                oneHundredGames: false,
                bigSpender: false,
                luckyStreak: false,
                seasonMaster: false,
                challengeKing: false
            }
        };

        const weeklyChallenges = [
            {
                id: 'streak',
                title: 'Win Streak Master',
                target: 3,
                reward: 1000000,
                check: (state) => state.weeklyProgress.winStreak >= 3
            },
            {
                id: 'highroller',
                title: 'High Roller',
                target: 10000000,
                reward: 10000000,
                check: (state) => state.weeklyProgress.totalBets >= 10000000
            },
            {
                id: 'multiplier',
                title: 'Multiplier King',
                target: 1000,
                reward: 500000,
                check: (state) => state.weeklyProgress.highestMultiplier >= 1000
            }
        ];

        function updateChallenges(data) {
            const container = document.getElementById('weekly-challenges');
            container.innerHTML = '';

            weeklyChallenges.forEach(challenge => {
                const progress = getProgressForChallenge(challenge.id);
                const percentage = Math.min((progress / challenge.target) * 100, 100);
                const progressFormatted = Math.min(progress, challenge.target);

                if (progress >= challenge.target && !gameState.weeklyProgress.completedChallenges[challenge.id]) {
                    gameState.balance += challenge.reward;
                    balanceAnimator.animate(gameState.balance);

                    gameState.weeklyProgress.completedChallenges[challenge.id] = true;

                    showMessage(`Challenge Complete: ${challenge.title}! +€${formatNumber(challenge.reward)}`, '#00ff4c');

                    saveGameState();
                }

                const challengeEl = document.createElement('div');
                challengeEl.className = 'challenge-item';
                const isCompleted = gameState.weeklyProgress.completedChallenges[challenge.id];

                challengeEl.innerHTML = `
         <div class="challenge-title">
         ${challenge.title}
         ${isCompleted ? '<span style="color: #00ff4c"> ✓</span>' : ''}
         </div>
         <div>${formatNumber(progressFormatted).slice(0, -3)}/${formatNumber(challenge.target).slice(0, -3)}</div>
         <div class="progress-bar">
         <div class="progress-fill" style="width: ${percentage}%"></div>
         </div>
         <div style="font-size: 0.8em; color: #ffd700; margin-top: 3px; font-weight: bold;">Reward: €${formatNumber(challenge.reward)}</div>
         `;

                container.appendChild(challengeEl);
            });
        }

        function getProgressForChallenge(challengeId) {
            switch (challengeId) {
                case 'streak':
                    return gameState.weeklyProgress.winStreak;
                case 'highroller':
                    return gameState.weeklyProgress.totalBets;
                case 'multiplier':
                    return gameState.weeklyProgress.highestMultiplier;
                default:
                    return 0;
            }
        }

        class BalanceAnimator {
            constructor(element) {
                this.element = element;
                this.currentValue = 0;
                this.targetValue = 0;
                this.startValue = 0;
                this.animationFrame = null;
                this.startTime = null;
            }

            animate(newTarget, duration = 200) {
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }

                this.startValue = this.currentValue;
                this.targetValue = newTarget;
                this.startTime = performance.now();

                const updateFrame = (currentTime) => {
                    if (!this.startTime) this.startTime = currentTime;
                    const elapsed = currentTime - this.startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    const easeOutCubic = 1 - Math.pow(1 - progress, 3);

                    this.currentValue = this.startValue + (this.targetValue - this.startValue) * easeOutCubic;

                    this.element.textContent = formatNumber(this.currentValue.toFixed(2));

                    if (progress < 1) {
                        this.animationFrame = requestAnimationFrame(updateFrame);
                    }
                };

                this.animationFrame = requestAnimationFrame(updateFrame);
            }
        }

        class XPAnimator {
            constructor(element) {
                this.element = element;
                this.currentValue = 0;
                this.targetValue = 0;
                this.startValue = 0;
                this.animationFrame = null;
                this.startTime = null;
            }

            animate(newTarget, duration = 200) {
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }

                this.startValue = this.currentValue;
                this.targetValue = newTarget;
                this.startTime = performance.now();

                const updateFrame = (currentTime) => {
                    if (!this.startTime) this.startTime = currentTime;
                    const elapsed = currentTime - this.startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    const easeOutCubic = 1 - Math.pow(1 - progress, 3);

                    this.currentValue = this.startValue + (this.targetValue - this.startValue) * easeOutCubic;

                    this.element.textContent = `${formatNumber(this.currentValue.toFixed(2)).slice(0, -3)}/${formatNumber(gameState.level.toFixed(0) * 100).slice(0, -3)}`

                    if (progress < 1) {
                        this.animationFrame = requestAnimationFrame(updateFrame);
                    }
                };

                this.animationFrame = requestAnimationFrame(updateFrame);
            }
        }

        const balanceAnimator = new BalanceAnimator(balanceEl);
        const xpAnimator = new XPAnimator(levelXpEl);

        const DEFAULT_GAME_STATE = {
            balance: 1000,
            level: 1,
            xp: 0,
            streak: 0,
            soundEnabled: true,
            dailyChallenge: {
                type: 'multiplier',
                target: 1000,
                current: 0,
                completed: false
            },
            gameCount: 0,
            weeklyProgress: {
                winStreak: 0,
                highestMultiplier: 0,
                totalBets: 0,
                totalWinnings: 0,
                completedChallenges: {}
            },
            achievements: {
                firstWin: false,
                tenXWin: false,
                oneHundredGames: false,
                bigSpender: false,
                luckyStreak: false,
                seasonMaster: false,
                challengeKing: false
            }
        };

        // Save game state with validation and error handling
        function saveGameState() {
            try {
                // Ensure minimum balance
                if (gameState.balance < 1000) {
                    gameState.balance = 1000;
                }

                // Validate and sanitize important values
                gameState.level = Math.max(1, Math.floor(gameState.level));
                gameState.xp = Math.max(0, gameState.xp);
                gameState.streak = Math.max(0, gameState.streak);
                gameState.gameCount = Math.max(0, gameState.gameCount);

                // Ensure all required properties exist
                const sanitizedState = {
                    ...DEFAULT_GAME_STATE,
                    ...gameState,
                    weeklyProgress: {
                        ...DEFAULT_GAME_STATE.weeklyProgress,
                        ...gameState.weeklyProgress
                    },
                    achievements: {
                        ...DEFAULT_GAME_STATE.achievements,
                        ...gameState.achievements
                    },
                    dailyChallenge: {
                        ...DEFAULT_GAME_STATE.dailyChallenge,
                        ...gameState.dailyChallenge
                    }
                };

                // Add timestamp for tracking save age
                sanitizedState.lastSaved = Date.now();

                // Save to localStorage
                localStorage.setItem('hakStonksState', JSON.stringify(sanitizedState));

                // Create backup save
                localStorage.setItem('hakStonksState_backup', JSON.stringify(sanitizedState));

                return true;
            } catch (error) {
                console.error('Error saving game state:', error);
                return false;
            }
        }

        function loadGameState() {
            try {
                // Attempt to load primary save
                const savedState = localStorage.getItem('hakStonksState');
                let parsedState;

                if (savedState) {
                    parsedState = JSON.parse(savedState);
                } else {
                    // Try loading from backup if primary save doesn't exist
                    const backupState = localStorage.getItem('hakStonksState_backup');
                    if (backupState) {
                        parsedState = JSON.parse(backupState);
                    }
                }

                // If no valid save exists, return default state
                if (!parsedState) {
                    return { ...DEFAULT_GAME_STATE };
                }

                // Merge saved state with default state to ensure all properties exist
                const mergedState = {
                    ...DEFAULT_GAME_STATE,
                    ...parsedState,
                    weeklyProgress: {
                        ...DEFAULT_GAME_STATE.weeklyProgress,
                        ...parsedState.weeklyProgress,
                        completedChallenges: {
                            ...DEFAULT_GAME_STATE.weeklyProgress.completedChallenges,
                            ...(parsedState.weeklyProgress?.completedChallenges || {})
                        }
                    },
                    achievements: {
                        ...DEFAULT_GAME_STATE.achievements,
                        ...parsedState.achievements
                    },
                    dailyChallenge: {
                        ...DEFAULT_GAME_STATE.dailyChallenge,
                        ...parsedState.dailyChallenge
                    }
                };

                // Ensure minimum balance
                mergedState.balance = Math.max(1000, mergedState.balance);

                // Validate numerical values
                mergedState.level = Math.max(1, Math.floor(mergedState.level));
                mergedState.xp = Math.max(0, mergedState.xp);
                mergedState.streak = Math.max(0, mergedState.streak);
                mergedState.gameCount = Math.max(0, mergedState.gameCount);

                return mergedState;
            } catch (error) {
                console.error('Error loading game state:', error);
                // Return default state if loading fails
                return { ...DEFAULT_GAME_STATE };
            }
        }

        function formatNumber(n) {
            return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
        }

        function updateGameStateUI() {
            balanceAnimator.animate(gameState.balance);
            levelEl.textContent = gameState.level;
            xpAnimator.animate(gameState.xp)
        }

        const multipliers = [
            1000, 10, 5, 2.5, 1, 0.5, 0.5, 1, 2.5, 5, 10, 1000
        ];

        function playSound(soundElement) {
            const newSound = new Audio(soundElement.src);
            newSound.muted = isMuted;
            newSound.play();
        }

        function showMessage(message, color = '#fff') {
            messageOverlay.textContent = message;
            messageOverlay.style.color = color;
            messageOverlay.style.opacity = 1;
            setTimeout(() => {
                messageOverlay.style.opacity = 0;
            }, 2000);
        }

        function createSparkles(x, y, count = 20) {
            for (let i = 0; i < count; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = `${x + (Math.random() * 40 - 20)}px`;
                sparkle.style.top = `${y + (Math.random() * 40 - 20)}px`;
                board.appendChild(sparkle);

                setTimeout(() => {
                    sparkle.remove();
                }, 600);
            }
        }

        function getMultiplierColor(multiplier) {
            if (multiplier >= 20) return '#ff0000';
            if (multiplier >= 10) return '#ff4444';
            if (multiplier >= 3) return '#ff8c00';
            if (multiplier >= 2) return '#ffd700';
            return '#4682B4';
        }

        const pegRows = 15;
        const boardWidth = board.offsetWidth;
        const boardHeight = board.offsetHeight;

        for (let row = 0; row < pegRows; row++) {
            const pegsInRow = row + 13;
            const yPos = (row + 1) * (boardHeight - 100) / (pegRows + 1);

            for (let col = 0; col < pegsInRow; col++) {
                const peg = document.createElement('div');
                peg.className = 'peg';

                const xPos = (boardWidth / 2) + (col - (pegsInRow / 2)) * (boardWidth / (pegRows * 2));
                peg.style.left = `${xPos}px`;
                peg.style.top = `${yPos}px`;
                board.appendChild(peg);
            }
        }

        function createBuckets() {
            const bucketsContainer = document.querySelector('.buckets');
            multipliers.forEach((multiplier, index) => {
                const bucket = document.createElement('div');
                bucket.className = 'bucket';
                bucket.style.backgroundColor = getMultiplierColor(multiplier);

                const intensity = Math.min(1, multiplier / 20);
                bucket.style.boxShadow = `0 0 ${15 * intensity}px rgba(255, 0, 0, ${0.5 * intensity})`;

                bucket.innerHTML = `
                     <div class="multiplier">${multiplier}x</div>
                 `;
                bucketsContainer.appendChild(bucket);
            });
        }

        function updateAchievements(data) {
            const achievements = gameState.achievements;
            let newAchievement = false;

            if (data.multiplier >= 2 && !achievements.firstWin) {
                achievements.firstWin = true;
                showAchievement("First Win!");
                newAchievement = true;
            }

            if (data.multiplier >= 10 && !achievements.tenXWin) {
                achievements.tenXWin = true;
                showAchievement("10x Multiplier Master!");
                newAchievement = true;
            }

            gameState.gameCount++;
            if (gameState.gameCount >= 100 && !achievements.oneHundredGames) {
                achievements.oneHundredGames = true;
                showAchievement("100 Game Marathon!");
                newAchievement = true;
            }

            return newAchievement;
        }

        function showAchievement(name) {
            achievementNameEl.textContent = name;
            achievementPopup.classList.add('show');
            setTimeout(() => {
                achievementPopup.classList.remove('show');
            }, 3000);
        }

        async function updateLevel(xpGained) {
            gameState.xp += xpGained;
            const xpToNextLevel = gameState.level * 100;

            if (gameState.xp >= xpToNextLevel) {
                gameState.level++;
                gameState.xp -= xpToNextLevel;
                levelEl.textContent = gameState.level;
                showMessage(`Level Up! 🆙 Now at Level ${gameState.level}`, '#00ff4c');

                const username = localStorage.getItem('hakStonksUsername');
                if (username) {
                    try {
                        const { error } = await supabaseClient
                            .from('Leaderboard')
                            .update({ level: gameState.level })
                            .eq('user', username);

                        if (error) throw error;
                    } catch (error) {
                        console.error('Error updating leaderboard:', error);
                    }
                }

                showLeaderboard();

                if (gameState.level % 5 === 0) {
                    gameState.balance += gameState.level * 50;
                    balanceAnimator.animate(gameState.balance);
                    showMessage(`Bonus €${gameState.level * 50} for reaching Level ${gameState.level}!`, '#ffd700');
                }
            }

            xpAnimator.animate(gameState.xp);
        }

        function updateDailyChallenge(multiplier) {
            const challenge = gameState.dailyChallenge;

            if (challenge.type === 'multiplier' && multiplier >= challenge.target) {
                challenge.current++;
                dailyChallengeProgress.textContent = `${challenge.current}/1`;

                if (challenge.current >= 1) {
                    challenge.completed = true;
                    gameState.balance += 100000;
                    showMessage('Daily Challenge Completed! + €100000 Bonus', '#00ff4c');
                    balanceAnimator.animate(gameState.balance);
                }
            }
        }

        function getRandomPosition() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            const maxX = windowWidth - 100;
            const maxY = windowHeight - 100;

            return {
                x: Math.floor(Math.random() * maxX),
                y: Math.floor(Math.random() * maxY)
            };
        }

        function mediumWinVideo() {
            const videoContainer = document.createElement('div');
            videoContainer.style.position = 'absolute';

            const { x, y } = getRandomPosition();
            videoContainer.style.left = `${x}px`;
            videoContainer.style.top = `${y}px`;

            videoContainer.style.transform = 'scale(0)';
            videoContainer.style.opacity = '0';
            videoContainer.style.zIndex = '1000';
            videoContainer.style.pointerEvents = 'none';

            videoContainer.style.animation = 'randomPopIn 0.25s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards, randomPopOut 0.25s 1.5s forwards';

            const video = document.createElement('video');
            video.setAttribute('autoplay', '');
            video.setAttribute('playsinline', '');
            video.muted = isMuted;
            video.style.width = '100px';
            video.style.height = 'auto';
            video.style.border = '2px solid #ff006e';
            video.style.borderRadius = '30%';

            const source = document.createElement('source');
            source.setAttribute('src', 'medium-win-video.mp4');
            source.setAttribute('type', 'video/mp4');

            video.appendChild(source);
            videoContainer.appendChild(video);
            document.body.appendChild(videoContainer);

            const style = document.createElement('style');
            style.textContent = `
                 @keyframes randomPopIn {
                     0% {
                         transform: scale(0);
                         opacity: 0;
                     }
                     100% {
                         transform: scale(1);
                         opacity: 1;
                     }
                 }
                 @keyframes randomPopOut {
                     0% {
                         transform: scale(1);
                         opacity: 1;
                     }
                     100% {
                         transform: scale(0);
                         opacity: 0;
                     }
                 }
             `;
            document.head.appendChild(style);

            setTimeout(() => {
                videoContainer.remove();
                document.head.removeChild(style);
            }, 3000);
        }

        function bigWinVideo() {
            const videoContainer = document.createElement('div');
            videoContainer.style.position = 'absolute';
            videoContainer.style.right = '-300px';
            videoContainer.style.animation = 'floatIn 3s forwards, rotateAndDisappear 3s forwards';
            videoContainer.style.pointerEvents = 'none';

            const video = document.createElement('video');
            video.setAttribute('autoplay', '');
            video.setAttribute('playsinline', '');
            video.muted = isMuted;
            video.style.width = '400px';
            video.style.height = 'auto';
            video.style.border = '2px solid #ff006e';
            video.style.borderRadius = '30%';

            const source = document.createElement('source');
            source.setAttribute('src', 'big-win-video.mp4');
            source.setAttribute('type', 'video/mp4');
            video.appendChild(source);

            videoContainer.appendChild(video);

            document.body.appendChild(videoContainer);

            const style = document.createElement('style');
            style.textContent = `
                 @keyframes floatIn {
                     0% {
                         right: -400px;
                         transform: rotate(0deg);
                     }
                     100% {
                         right: 38%;
                         transform: translateX(50%) rotate(0deg);
                     }
                 }
                 @keyframes rotateAndDisappear {
                     0% {
                         transform: rotate(-1400deg) scale(1);
                     }
                     50% {
                         transform: rotate(0deg) scale(1);
                     }
                     80% {
                         transform: rotate(0deg) scale(1);
                     }
                     100% {
                         transform: rotate(0deg) scale(0);
                     }
                 }
             `;
            document.head.appendChild(style);

            setTimeout(() => {
                videoContainer.remove();
            }, 3000);
        }

        function createChipPath() {
            const path = [];
            for (let i = 0; i < pegRows; i++) {
                const random = Math.random();
                if (random < 0.4) path.push(-1);
                else if (random < 0.8) path.push(1);
                else path.push(0);
            }
            return path;
        }

        function updateStreak(multiplier) {
            const baseMultipliers = [1, 1.25, 1.5, 1.75, 2, 2.25, 2.5];

            if (multiplier >= 2) {
                gameState.streak++;
                gameState.weeklyProgress.winStreak++;

                if (multiplier > gameState.weeklyProgress.highestMultiplier) {
                    gameState.weeklyProgress.highestMultiplier = multiplier;
                }

                const streakBonus = baseMultipliers[
                    Math.min(gameState.streak - 1, baseMultipliers.length - 1)
                ];

                return streakBonus;
            } else {
                gameState.streak = 0;
                gameState.weeklyProgress.winStreak = 0;
                return 1;
            }
        }

        function coinDrop() {
            const exists = document.getElementById('coinDrop');
            if (exists) {
                exists.parentNode.removeChild(exists);
                return false;
            }
            const element = document.querySelector("body");
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const coin = new Image();
            const coins = [];
            let focused = true;
            let addNewCoins = true;

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.id = 'coinDrop';
            canvas.style.position = "absolute";
            canvas.style.top = "0";
            canvas.style.left = "0";

            coin.src = 'coin.png';
            coin.onload = () => {
                element.appendChild(canvas);
                drawLoop();
                setTimeout(() => {
                    addNewCoins = false;
                }, 2800);
            };

            function drawLoop() {
                if (!focused) return;
                requestAnimationFrame(drawLoop);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (addNewCoins && Math.random() < 0.3) {
                    coins.push({
                        x: Math.random() * canvas.width | 0,
                        y: -50,
                        dy: 3,
                        s: 0.5 + Math.random(),
                        state: Math.random() * 10 | 0
                    });
                }

                let i = coins.length;
                while (i--) {
                    const coinData = coins[i];
                    coinData.state = (coinData.state > 9) ? 0 : coinData.state + 0.1;
                    coinData.dy += 0.3;
                    coinData.y += coinData.dy;
                    ctx.drawImage(coin, 44 * Math.floor(coinData.state), 0, 44, 40,
                        coinData.x, coinData.y, 44 * coinData.s, 40 * coinData.s);

                    if (coinData.y > canvas.height) {
                        coins.splice(i, 1);
                    }
                }

                if (!addNewCoins && coins.length === 0) {
                    focused = false;
                    canvas.parentNode.removeChild(canvas);
                }
            }
        }

        function dropChip() {
            const trimmedInput = betInput.value.trim();
            const betAmount = parseFloat(trimmedInput) || 0;

            if (betAmount > gameState.balance) {
                showMessage('Insufficient balance!', '#ff0000');
                return;
            }
            if (betAmount <= 0) {
                showMessage('Not enough money bet!', '#ff0000');
                return;
            }

            gameState.weeklyProgress.totalBets += betAmount;
            gameState.balance -= betAmount;
            balanceAnimator.animate(gameState.balance);
            playSound(coinDropSound);

            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.style.left = `${boardWidth / 2}px`;
            chip.style.top = '0';
            board.appendChild(chip);

            const path = createChipPath();

            let currentStep = 0;
            let currentX = boardWidth / 2;
            let currentY = 0;



            function animate() {
                if (currentStep < path.length) {
                    const direction = path[currentStep];
                    currentX += direction * (boardWidth / 32);
                    currentY += (boardHeight - 100) / (pegRows + 1);

                    chip.style.left = `${currentX}px`;
                    chip.style.top = `${currentY}px`;

                    currentStep++;
                    setTimeout(animate, 80);
                } else {
                    const bucketIndex = Math.floor((currentX / boardWidth) * multipliers.length);
                    const actualBucketIndex = Math.max(0, Math.min(multipliers.length - 1, bucketIndex));
                    const baseMultiplier = multipliers[actualBucketIndex];

                    const streakBonus = updateStreak(baseMultiplier);
                    const totalMultiplier = baseMultiplier * streakBonus;
                    const winnings = betAmount * totalMultiplier;

                    gameState.balance += winnings;
                    balanceAnimator.animate(gameState.balance);

                    const buckets = document.querySelectorAll('.bucket');
                    buckets[actualBucketIndex].classList.add('winning');
                    setTimeout(() => {
                        buckets[actualBucketIndex].classList.remove('winning');
                    }, 100);

                    createSparkles(currentX, currentY);

                    if (baseMultiplier >= 10) {
                        bigWinVideo();
                        setTimeout(() => {
                            playSound(bigWinSound);
                        }, 150);
                        coinDrop();
                    } else if (baseMultiplier == 5) {
                        mediumWinVideo();
                        playSound(mediumWinSound);
                        setTimeout(() => {
                            playSound(mediumWinAudio);
                        }, 150);
                    } else if (baseMultiplier >= 3) {
                        playSound(winSound);
                    } else if (baseMultiplier > 1) {
                        playSound(cashSound);
                    }

                    const xpGained = Math.max(1, Math.log2(totalMultiplier) * 10);
                    updateLevel(xpGained);

                    const achievementData = {
                        multiplier: totalMultiplier
                    };
                    updateAchievements(achievementData);
                    updateDailyChallenge(totalMultiplier);
                    updateChallenges();
                    saveGameState();
                    updateGameStateUI();

                    if (baseMultiplier > 1) {
                        const messageColor = baseMultiplier >= 10 ? '#ff4444' : '#ffd700';
                        showMessage(`${baseMultiplier.toFixed(1)}x Win!`, messageColor);
                    }

                    setTimeout(() => {
                        chip.remove();
                    }, 500);
                }
            }

            animate();
        }

        createBuckets();

        const manualButton = document.querySelector('.mode-switch button:nth-child(1)');
        const autoButton = document.querySelector('.mode-switch button:nth-child(2)');

        manualButton.addEventListener('click', () => {
            isAutoMode = false;
            clearInterval(autoDropInterval);
            manualButton.classList.add('active');
            autoButton.classList.remove('active');
            dropBtn.disabled = false;
            dropBtnAll.disabled = false;
            dropBtn.style.display = "block"
            dropBtnAll.style.display = "block"
        });

        autoButton.addEventListener('click', () => {
            isAutoMode = true;
            manualButton.classList.remove('active');
            autoButton.classList.add('active');
            dropBtn.disabled = true;
            dropBtnAll.disabled = true;
            dropBtn.style.display = "none"
            dropBtnAll.style.display = "none"
            startAutoDrop();
        });

        function startAutoDrop() {
            if (autoDropInterval) clearInterval(autoDropInterval);

            autoDropInterval = setInterval(() => {
                dropChip();
            }, 100);
        }

        window.addEventListener('focus', () => {
            isPageFocused = true;
        });

        window.addEventListener('blur', () => {
            isPageFocused = false;

            isSpaceHeld = false;
            clearInterval(spaceHoldInterval);
        });

        dropBtn.addEventListener('click', () => {
            if (!isAutoMode) {
                dropChip();
            }
        });

        dropBtnAll.addEventListener('click', () => {
            if (!isAutoMode) {
                const currentBet = betInput.value;
                betInput.value = gameState.balance;
                dropChip();
                betInput.value = currentBet;
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && isPageFocused && !isAutoMode) {
                e.preventDefault();
                if (!isSpaceHeld) {
                    isSpaceHeld = true;
                    dropChip();

                    spaceHoldInterval = setInterval(() => {
                        dropChip();
                    }, 100);
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                isSpaceHeld = false;
                clearInterval(spaceHoldInterval);
            }
        });

        function setCookie(name, value, days) {
            const item = {
                value: value,
                expiry: new Date().getTime() + (days * 24 * 60 * 60 * 1000)
            };
            localStorage.setItem(name, JSON.stringify(item));
        }

        function getCookie(name) {
            const itemStr = localStorage.getItem(name);

            if (!itemStr) {
                return null;
            }

            const item = JSON.parse(itemStr);
            const now = new Date().getTime();

            if (now > item.expiry) {
                localStorage.removeItem(name);
                return null;
            }

            if (item.value === 'accepted' || item.value === 'declined') {
                return true;
            }

            return null;
        }

        function handleCookieConsent() {
            const cookieConsent = document.getElementById('cookie-consent');
            const acceptButton = document.getElementById('accept-cookies');
            const declineButton = document.getElementById('decline-cookies');

            const consentChoice = getCookie('cookieConsentHAKStonks');
            if (consentChoice) {
                return;
            }

            cookieConsent.style.display = 'block';

            cookieConsent.style.display = 'block';

            acceptButton.addEventListener('click', () => {
                setCookie('cookieConsentHAKStonks', 'accepted', 365);
                cookieConsent.style.display = 'none';
            });

            declineButton.addEventListener('click', () => {
                setCookie('cookieConsentHAKStonks', 'declined', 365);
                cookieConsent.style.display = 'none';
            });
        }

        const supabaseUrl = 'https://cdvumrkxfzlpepughpgx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkdnVtcmt4ZnpscGVwdWdocGd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0ODI4MDQsImV4cCI6MjA0ODA1ODgwNH0.gjHLIhTH7U2y_4kd6h6ZyKWTaa04iMLVbIos9KJF0_s';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        async function showLeaderboard() {
            try {
                const { data, error } = await supabaseClient
                    .from('Leaderboard')
                    .select('*');

                if (error) throw error;

                data.sort((a, b) => b.level - a.level);

                const rowsContainer = document.getElementById('leaderboard');

                let tableHTML = '<table><thead><tr><th>User</th><th>Level</th></tr></thead><tbody>';

                data.forEach(row => {
                    tableHTML += `
                <tr>
                    <td style="border-top-left-radius: 10px; border-bottom-left-radius: 10px;">${row.user}</td>
                    <td style="border-top-right-radius: 10px; border-bottom-right-radius: 10px;">${row.level}</td>
                </tr>
            `;
                });

                tableHTML += '</tbody></table>';

                rowsContainer.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        const musicTracks = [
            document.getElementById('background-music-1'),
            document.getElementById('background-music-2'),
            document.getElementById('background-music-3'),
            document.getElementById('background-music-4'),
            document.getElementById('background-music-5'),
            document.getElementById('background-music-6')
        ];

        let previousTrackIndex = -1;

        const playCurrentTrack = (index) => {
            const currentTrack = musicTracks[index];
            currentTrack.play().catch(error => {
                console.error("Autoplay failed:", error);
            });
        };

        const stopAllTracks = () => {
            musicTracks.forEach(track => {
                track.pause();
                track.currentTime = 0;
            });
        };

        const playRandomTrack = () => {
            stopAllTracks();
            let nextTrackIndex;

            do {
                nextTrackIndex = Math.floor(Math.random() * musicTracks.length);
            } while (nextTrackIndex === previousTrackIndex);

            previousTrackIndex = nextTrackIndex;
            playCurrentTrack(nextTrackIndex);
        };

        let hasStarted = false;

        const events = ['click', 'touchstart', 'keydown'];
        events.forEach(event => {
            document.addEventListener(event, () => {
                if (!hasStarted) {
                    hasStarted = true;
                    playRandomTrack();
                }
            });
        });

        musicTracks.forEach(track => {
            track.addEventListener('ended', playRandomTrack);
        });

        const muteBtn = document.getElementById('mute-btn');

        function saveMutedState() {
            localStorage.setItem('isMuted', isMuted);
        }

        function loadMutedState() {
            const savedState = localStorage.getItem('isMuted');
            if (savedState !== null) {
                isMuted = JSON.parse(savedState);
                musicTracks.forEach(track => {
                    track.muted = isMuted;
                });
                muteBtn.textContent = isMuted ? '🔈' : '🔊';
            }
        }

        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            musicTracks.forEach(track => {
                track.muted = isMuted;
            });
            muteBtn.textContent = isMuted ? '🔈' : '🔊';
            saveMutedState();
        });

        function showUsernamePrompt() {
            const savedUsername = localStorage.getItem('hakStonksUsername');
            if (!savedUsername) {
                const usernameModal = document.createElement('div');
                usernameModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, var(--primary-color), var(--background-dark));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        `;

                modalContent.innerHTML = `
            <h2 style="
                font-family: 'Orbitron', sans-serif;
                font-size: 2rem;
                margin-bottom: 1.5rem;
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
                letter-spacing: 2px;
                color: var(--text-light);
            ">Welcome to HAKStonks!</h2>
            
            <p style="
                color: var(--text-dim);
                margin-bottom: 1.5rem;
                font-weight: 500;
            ">Please choose a username:</p>
            
            <input type="text" id="username-input" autocomplete="off" style="
                width: 100%;
                padding: 1rem;
                background: rgba(0, 0, 0, 0.2);
                border: 2px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: var(--text-light);
                margin-bottom: 1rem;
                font-size: 1.1rem;
                transition: all 0.3s ease;
                outline: none;
            " maxlength="20">
            
            <button id="submit-username" style="
                width: 100%;
                padding: 1rem;
                background: linear-gradient(135deg, var(--accent-color), #00cc6a);
                border: none;
                border-radius: 12px;
                color: var(--primary-color);
                font-weight: 600;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-top: 0.5rem;
            ">Start Playing</button>
            
            <p id="username-error" style="
                color: var(--secondary-color);
                margin-top: 1rem;
                display: none;
                font-size: 0.9rem;
                font-weight: 500;
            ">Username must be between 3 and 20 characters</p>
        `;

                document.body.appendChild(usernameModal);

                const usernameInput = modalContent.querySelector('#username-input');
                const submitButton = modalContent.querySelector('#submit-username');
                const errorMessage = modalContent.querySelector('#username-error');

                submitButton.onmouseover = () => {
                    submitButton.style.transform = 'translateY(-2px)';
                    submitButton.style.boxShadow = '0 8px 25px rgba(0, 255, 136, 0.4)';
                };
                submitButton.onmouseout = () => {
                    submitButton.style.transform = 'translateY(0)';
                    submitButton.style.boxShadow = 'none';
                };

                usernameInput.onfocus = () => {
                    usernameInput.style.borderColor = 'var(--secondary-color)';
                    usernameInput.style.boxShadow = '0 0 15px rgba(255, 0, 110, 0.3)';
                };
                usernameInput.onblur = () => {
                    usernameInput.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                    usernameInput.style.boxShadow = 'none';
                };

                submitButton.addEventListener('click', async () => {
                    const username = usernameInput.value.trim();
                    if (username.length >= 3 && username.length <= 20) {
                        try {
                            const { data: existingUser } = await supabaseClient
                                .from('Leaderboard')
                                .select('user')
                                .eq('user', username)
                                .single();

                            if (existingUser) {
                                errorMessage.textContent = 'Username already taken';
                                errorMessage.style.display = 'block';
                                return;
                            }

                            const { error } = await supabaseClient
                                .from('Leaderboard')
                                .insert([
                                    { user: username, level: gameState.level }
                                ]);

                            if (error) throw error;

                            localStorage.setItem('hakStonksUsername', username);
                            usernameModal.remove();
                            showMessage('Welcome, ' + username + '!', '#ff006e');
                            showLeaderboard();
                        } catch (error) {
                            console.error('Error creating user:', error);
                            errorMessage.textContent = 'Error creating user. Please try again.';
                            errorMessage.style.display = 'block';
                        }
                    } else {
                        errorMessage.style.display = 'block';
                    }
                });

                usernameModal.appendChild(modalContent);
            }
        }
    </script>
</body>

</html>